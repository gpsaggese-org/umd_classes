# Bitcoin Real-Time Monitoring & Validation — Technical Breakdown

## Table of Contents

- [Bitcoin Real-Time Monitoring & Validation — Technical Breakdown](#bitcoin-real-time-monitoring--validation--technical-breakdown)
- [Purpose of this Document](#purpose-of-this-document)
- [Module Overview](#module-overview)
- [Detailed File Breakdown](#detailed-file-breakdown)
  - [Module: bitcoin_utils.py](#module-bitcoin_utilspy)
  - [Module: bitcoin.API.py](#module-bitcoinapipy)
  - [Module: bitcoin.API.ipynb](#module-bitcoinapiipynb)
- [Conclusion](#conclusion)

---

## Purpose of this Document

This document provides a detailed explanation of three key files used in the Bitcoin real-time data ingestion and validation workflow:

- **`bitcoin_utils.py`**  
  Contains core utility functions for fetching Bitcoin data from CoinGecko API, saving data to CSV files, validating data against expectations, and checking time intervals.

- **`bitcoin.API.py`**  
  Defines the `BitcoinAPI` class which integrates the utilities into a full pipeline to fetch, validate, log, and document Bitcoin market data using Great Expectations.

- **`bitcoin.API.ipynb`**  
  A Jupyter Notebook demonstrating how to use the `BitcoinAPI` class to perform real-time Bitcoin data ingestion, validation, and generate data documentation.

---

## Module Overview

The `bitcoin.API.py` module provides the `BitcoinAPI` class for real-time ingestion, validation, and documentation of Bitcoin price data using Great Expectations.  
It supports fetching Bitcoin market data from CoinGecko API, appending it to a CSV log, validating the data using an expectation suite, and generating Great Expectations Data Docs automatically.  
It ensures data quality before storage and later analysis, making it suitable for real-time data workflows.

In the following section, we provide a breakdown of each core module used in the project, along with a detailed explanation of its components and logic.

---

## Detailed File Breakdown

The following three modules work together to implement the full data ingestion, validation, and documentation workflow:

- **`bitcoin_utils.py`**  
  Contains core utility functions for fetching, saving, validating, and time-checking Bitcoin data. These low-level tools are shared by other components.

- **`bitcoin.API.py`**  
  Wraps the utility functions into a high-level reusable pipeline using the `BitcoinAPI` class. This is the main logic hub of the system.

- **`bitcoin.API.ipynb`**  
  Demonstrates how to use the `BitcoinAPI` class in a real-world scenario. It runs the full pipeline step by step, shows validation output, and generates documentation.

---

### Module: bitcoin_utils.py

This module defines a collection of helper functions used to support real-time Bitcoin data fetching, validation, saving, and basic data integrity checking.

---

#### Function 1: fetch_full_bitcoin_snapshot()

```python
fetch_full_bitcoin_snapshot() -> pd.DataFrame
```

- **Purpose:**  
  Fetch the latest Bitcoin market snapshot from the CoinGecko public API endpoint  
  [`https://api.coingecko.com/api/v3/coins/bitcoin`](https://api.coingecko.com/api/v3/coins/bitcoin).  
  This function extracts key financial indicators from the response JSON and formats them into a one-row `DataFrame`.

  The returned data includes the following fields:

  | Column              | Description                                                                 |
  |---------------------|-----------------------------------------------------------------------------|
  | `timestamp`         | UTC time when the data was fetched (generated by `datetime.utcnow()`)      |
  | `last_updated`      | Last update timestamp provided by the API                                  |
  | `price_usd`         | Current Bitcoin price in USD                                                |
  | `price_24h_change`  | Percentage price change in the last 24 hours                               |
  | `market_cap`        | Total market capitalization in USD                                          |
  | `market_cap_rank`   | Market cap ranking among all cryptocurrencies                               |
  | `total_volume`      | 24-hour trading volume in USD                                               |
  | `circulating_supply`| Number of Bitcoins currently in circulation                                |
  | `developer_score`   | Developer activity score (from CoinGecko's scoring model)                   |
  | `community_score`   | Community engagement score (also from CoinGecko metrics)                    |
  | `ath`               | All-time high price in USD                                                  |
  | `atl`               | All-time low price in USD                                                   |
  | `valid`             | A boolean flag set to `True` (for validation tracking)                      |

  This structured data serves as the foundation for all downstream processing, validation, and analysis.

- **Input Parameters:**  
  None

- **Return Value:**  
  Returns a one-row `pandas.DataFrame` containing Bitcoin market statistics.

---

#### Function 2: save_to_csv()

```python
save_to_csv(df: pd.DataFrame, filename: str = "bitcoin_price_log.csv") -> None
```
- **Purpose:**  
  Provide a utility to write any given `DataFrame` into a specified CSV file (typically `bitcoin_price_log.csv`).  
  This function **does not fetch or log data by itself**, but can be called by other functions when needed.  
  If the target CSV file already exists, the data is appended to the bottom of the file. Otherwise, a new file is created.

- **Input Parameters:**
  - `df` (`pandas.DataFrame`): The dataset to save.
  - `filename` (`str`): Destination file path.

- **Return Value:**  
  None

---

#### Function 3: fetch_and_log_price()

```python
fetch_and_log_price(output_file: str = "bitcoin_price_log.csv") -> None
```
- **Purpose:**  
  Fetch a real-time snapshot of Bitcoin market data and log it into a CSV file using the `save_to_csv()` utility.  
  This function combines data retrieval and storage into one step.  
  By default, data is stored in `bitcoin_price_log.csv`, which accumulates all historical snapshots.

- **Input Parameters:**
  - `output_file` (`str`): Destination CSV file path.

- **Return Value:**  
  None

---

#### Function 4: check_time_interval()

```python
check_time_interval(df: pd.DataFrame, threshold_minutes: int = 60) -> bool
```
- **Purpose:**  
  Validate that the timestamps between the last two rows of data are not too far apart, ensuring regular and reliable data capture.

  This check directly supports the project requirement:  
  **“Time intervals to ensure the data is regularly updated and retrieved.”**

  However, this kind of **temporal consistency check** is **not suitable to be handled directly within Great Expectations**, because:
  - Great Expectations focuses on validating **data values and schema** within a single dataset.
  - It does **not maintain memory of time intervals between separate fetches**.

  Therefore, we implemented this check as a **standalone Python function**, outside of the GE framework.  
  This allows us to independently evaluate whether new data is arriving at a consistent rate.

- **Input Parameters:**
  - `df` (`pandas.DataFrame`): DataFrame containing `timestamp` field.
  - `threshold_minutes` (`int`): Maximum allowed gap (default: 60 minutes).

- **Return Value:**  
  Returns `True` if the interval is acceptable, `False` if the interval is too large.

---

#### Function 5: validate_data()

```python
validate_data(df: pd.DataFrame, suite_name: str = "bitcoin_suite", datasource_name: str = "my_datasource") -> dict
```
- **Purpose:**  
  Validate a Bitcoin dataset using a Great Expectations expectation suite.  

  This function is a core component of the project, responsible for building and executing a comprehensive set of data expectations to ensure data quality.

  While the primary goal includes validating the expected price range, we went far beyond that.  
  We thoroughly analyzed all relevant fields returned by CoinGecko’s API and designed custom validation logic for each important attribute.

  This is the most critical step of the entire project, as it defines the expected behavior of the data and prevents invalid or suspicious data from being accepted into our log.

  The following table summarizes the expectations applied to each column.  
  Each validation rule was carefully designed based on the observed behavior of real-time Bitcoin market data:


| Column               | Expectation Description                                                                 |
|----------------------|------------------------------------------------------------------------------------------|
| `price_usd`          | Must exist (not null). Must be between 20,000 and 100,000 USD (based on recent range).  |
| `market_cap`         | Must exist. Must be a float. Value between 300B and 2.5T USD (historical cap).           |
| `total_volume`       | Must be a float. Value between 5B and 100B USD (estimated daily volume).                 |
| `market_cap_rank`    | Must be between 1 and 300 (Bitcoin is consistently highly ranked).                       |
| `circulating_supply` | Value between 18M and 22M BTC (Bitcoin supply design).                                   |
| `developer_score`    | Value between 0 and 100 (CoinGecko developer metric).                                    |
| `community_score`    | Value between 0 and 100 (CoinGecko community metric).                                    |
| `ath`                | Must be greater than 1000 USD (reasonable historical ATH).                               |
| `atl`                | Must be greater than 0.01 USD (Bitcoin never fell below this).                           |
| `valid`              | Must be a boolean (True or False).                                                       |
| `last_updated`       | Must exist (not null).                                                                   |

  These expectations were designed based on empirical observations of real-time and historical Bitcoin data.  
  For instance, we reviewed multiple snapshots from CoinGecko over time and noted how price, market cap, volume, etc., fluctuated to define realistic but strict boundaries.

  This validation process ensures:
  - Early detection of anomalies or API glitches (e.g., nulls, wrong types, sudden huge jumps).
  - Cleaner datasets for downstream time series analysis.
  - Consistency with known Bitcoin behavior.

  The validation result includes whether the dataset passed or failed, and how many expectations were satisfied or violated.  
  It also integrates seamlessly with the Great Expectations Data Docs, giving us human-readable documentation and auditability.

- **Input Parameters:**
  - `df` (`pandas.DataFrame`): Dataset to validate.
  - `suite_name` (`str`): Great Expectations suite name.
  - `datasource_name` (`str`): Datasource name.

- **Return Value:**  
  Returns a `dict` containing validation results, success status, and statistics.

---

#### Function 6: summarize_validation_result()

```python
summarize_validation_result(result: dict) -> None
```
- **Purpose:**  
  Display a human-readable summary of the validation results, making it easy to quickly assess whether all expectations passed or if any failed.

- **Input Parameters:**
  - `result` (`dict`): Validation result dictionary.

- **Return Value:**  
  None

---

### Module: bitcoin.API.py

The main class that orchestrates real-time Bitcoin data ingestion, validation, and logging workflows.  
It builds upon utility functions defined in `bitcoin_utils.py`, including data fetching, saving, validation, and time interval checks, to form a reusable and modular pipeline.

---

#### Class: BitcoinAPI

---

#### Initialization

```python
BitcoinAPI(log_file: str = "bitcoin_price_log.csv")
```
- **Purpose:**  
  Create a `BitcoinAPI` instance connected to a specific CSV log file for storing validated Bitcoin data.  
  By default, the log file is named `bitcoin_price_log.csv`, which accumulates all snapshots fetched from the API.

- **Input Parameters:**
  - `log_file` (`str`): Path where data snapshots are stored.

---

#### Method 1: fetch()

```python
fetch(verbose: bool = True) -> pd.DataFrame
```
- **Purpose:**  
  Fetch a real-time snapshot of Bitcoin market data from the CoinGecko API.  
  This method internally calls the `fetch_full_bitcoin_snapshot()` function from `bitcoin_utils.py`,  
  which sends a request to `https://api.coingecko.com/api/v3/coins/bitcoin` and returns key metrics (e.g., price, volume, market cap) as a one-row `DataFrame`.

- **Input Parameters:**
  - `verbose` (`bool`): Print the fetched data if True.

- **Return Value:**  
  One-row `pandas.DataFrame` containing Bitcoin stats.

---

#### Method 2: append_to_log()

```python
append_to_log(df: pd.DataFrame) -> None
```
- **Purpose:**  
  Append a freshly fetched snapshot into the historical log file `bitcoin_price_log.csv`.  
  This method internally calls the `save_to_csv()` function from `bitcoin_utils.py`,  
  which handles writing or appending the provided `DataFrame` to the CSV file, preserving all previously logged entries.

- **Input Parameters:**
  - `df` (`pandas.DataFrame`): Bitcoin snapshot to append.

- **Return Value:**  
  None

---

#### Method 3: validate()

```python
validate(df: pd.DataFrame) -> dict
```
- **Purpose:**  
  Validate the current Bitcoin dataset against a custom expectation suite to ensure data quality.  
  This method internally calls the `validate_data()` function from `bitcoin_utils.py`,  
  which uses Great Expectations to check each important field for correct value ranges, types, and non-null constraints based on CoinGecko data.

- **Input Parameters:**
  - `df` (`pandas.DataFrame`): Data to validate.

- **Return Value:**  
  Validation result dictionary.

---

#### Method 4: run()

```python
run(verbose: bool = True) -> dict
```

- **Purpose:**  
  Execute the full data ingestion and validation pipeline in one step.  
  This method performs the following operations sequentially:

  1. **Fetch** — Calls `fetch()` to retrieve the latest Bitcoin snapshot via CoinGecko.  
     Internally uses `fetch_full_bitcoin_snapshot()` from `bitcoin_utils.py`.

  2. **Append** — Logs the fetched snapshot to `bitcoin_price_log.csv`.  
     Uses `append_to_log()`, which calls `save_to_csv()` from `bitcoin_utils.py`.

  3. **Validate** — Checks the entire dataset against Great Expectations rules.  
     Uses `validate()` which delegates to `validate_data()` in `bitcoin_utils.py`.

  4. **Build Data Docs** — If `verbose=True`, builds human-readable validation documentation using Great Expectations' `Data Docs`.

     The generated documentation includes a summary of all expectations and whether they passed or failed.
     It is automatically saved as a static HTML file at the following location:

     ```
     TutorTask127_Spring2025_Monitoring_Bitcoin_Prices_Using_Great_Expectations/gx/uncommitted/data_docs/local_site/index.html
     ```

     You can open this file in your browser to explore the Great Expectations Data Docs.
     It provides a user-friendly interface for inspecting validation results, reviewing individual expectation rules, identifying failed checks, and ensuring schema consistency over time.

- **Input Parameters:**
  - `verbose` (`bool`): Print detailed logs if True.

- **Return Value:**  
  A dictionary with validation results, or a skip indicator if fetch failed.

---

### Module: bitcoin.API.ipynb

This notebook acts as the main demonstration environment for executing the real-time Bitcoin ingestion and validation pipeline using the `BitcoinAPI` class.

---

#### Notebook Workflow Summary

This Jupyter notebook (`bitcoin.API.ipynb`) demonstrates how to run the **core real-time Bitcoin data ingestion and validation pipeline** using the `BitcoinAPI` class.

Its main purpose is to show how to execute the essential steps of the system end-to-end, including data fetching, logging, validation, and output preview — making it a compact, verifiable entry point for the project workflow.

The workflow includes the following steps:

- **Import the `BitcoinAPI` class**  
  Dynamically load the API class from `bitcoin.API.py`.

- **Create an instance of `BitcoinAPI`**  
  Initialize the class using its default parameter: the target CSV log file `bitcoin_price_log.csv`.

- **Run the full pipeline once**  
  Use `btc_api.run()` to:
  - Fetch the latest Bitcoin market snapshot from CoinGecko.
  - Append the data to the CSV log using `save_to_csv()`.
  - Validate the full dataset using Great Expectations.
  - Print validation summary.

- **Load the latest log data**  
  The notebook reads `bitcoin_price_log.csv` and displays the most recent entry using `df.tail(1)`.

- **Print completion confirmation**  
  A message is printed at the end to confirm the pipeline executed successfully.

This notebook focuses on real-time data ingestion, logging, validation, and generating Great Expectations documentation.

Advanced tasks—including time series trend analysis, volatility spike detection using z-score,  
and forecasting future prices with Holt-Winters Exponential Smoothing—are demonstrated  
in the separate notebook: `bitcoin.example.ipynb`.

---

## Conclusion

This modular architecture ensures that real-time Bitcoin data can be reliably ingested, validated, logged, and documented using Python and Great Expectations.  
By combining reusable utility functions, a centralized API pipeline, and demonstration notebooks, this system offers both flexibility and data quality assurance for time-series cryptocurrency analysis.

---